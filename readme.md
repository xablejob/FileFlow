Тестовое задание на позицию Middle Backend разработчик (Python)

# Задача

Разработать REST API микросервис для приёма, обработки и управления медиафайлами. Микросервис должен уметь принимать файлы через HTTP-запросы, сохранять их на локальный диск и отправлять копию в облачное хранилище. Для каждого файла должен быть сгенерирован уникальный идентификатор (UID), который будет использоваться для дальнейшей работы с файлом. Кроме того, необходимо сохранять метаданные файла в базу данных, включая размер, формат, оригинальное название и расширение файла.

Технологический стек:

Язык программирования: Python
Web-фреймворк: FastAPI

База данных: PostgreSQL

ORM: SQLAlchemy

Облачное хранилище: Использование условного API для демонстрации интеграции

Функциональные требования:

Приём файлом: API должен поддерживать загрузку файлов через HTTP POST запросы. Файлы могут быть любого типа (например, изображения, видео, аудио).

Потоковый приём файлов: API должен поддерживать загрузку файлов через стрим. Файлы могут быть любого типа (например, изображения, видео, аудио).

Сохранение файлов на диск: После приёма файл должен сохраняться на сервере.

Отправка в облако: Копия файла должна быть асинхронно отправлена в облачное хранилище.

Генерация UID: Для каждого файла должен быть сгенерирован уникальный идентификатор.

Сохранение метаданных: Метаданные каждого файла должны быть сохранены в базе данных PostgreSQL через SQLAlchemy. Метаданные включают размер файла, формат, оригинальное название и расширение.

Дополнительные задачи (Бонус):

Крон для очистки локального диска: Реализовать крон задачу, которая будет регулярно очищать старые или неиспользуемые файлы с локального диска.

Ручка для получения файла по UID: Реализовать API-метод для получения файла по его уникальному идентификатору, с возможностью скачивания файла.

Требования к коду:

Код должен быть чистым, хорошо структурированным и комментированным.

Решение должно включать обработку ошибок и базовые тесты функциональности.

# PlantUML схема (диаграмма последовательности)

```plantuml
@startuml
actor User
participant "Frontend" as F
participant "Backend" as B
database "PostgreSQL" as DB
participant "Cloud Storage" as CS

== Загрузка файла ==
User -> F: Выбирает файл для загрузки
F -> B: POST /api/v1/files
activate B
B -> B: Генерация UID
B -> B: Сохранение файла на диск
B -> DB: Сохранение метаданных
B --> F: Возврат UID и метаданных
F --> User: Отображение успеха загрузки
deactivate B

B -> CS: Асинхронная отправка файла
activate CS
CS --> B: Подтверждение загрузки
deactivate CS
B -> DB: Обновление cloud_path

== Потоковая загрузка файла ==
User -> F: Инициирует потоковую загрузку
F -> B: POST /api/v1/files/stream
activate B
B -> B: Генерация UID
B -> B: Потоковое сохранение на диск
B -> DB: Сохранение метаданных
B --> F: Возврат UID и метаданных
F --> User: Отображение прогресса и завершения
deactivate B

B -> CS: Асинхронная отправка файла
activate CS
CS --> B: Подтверждение загрузки
deactivate CS
B -> DB: Обновление cloud_path

== Получение файла по UID ==
User -> F: Запрос файла по UID
F -> B: GET /api/v1/files/{uid}
activate B
B -> DB: Запрос метаданных
DB --> B: Возврат метаданных
B -> B: Проверка наличия файла
B --> F: Отправка файла
F --> User: Отображение/скачивание файла
deactivate B

== Получение метаданных файла ==
User -> F: Запрос метаданных файла
F -> B: GET /api/v1/files/{uid}/metadata
activate B
B -> DB: Запрос метаданных
DB --> B: Возврат метаданных
B --> F: Отправка метаданных
F --> User: Отображение метаданных
deactivate B

== Крон для очистки локального диска ==
B -> B: Запуск крон-задачи
activate B
B -> DB: Запрос старых файлов
DB --> B: Список файлов для удаления
loop для каждого старого файла
    B -> B: Удаление с диска
    B -> DB: Обновление статуса
end
deactivate B
@enduml
```
